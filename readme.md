# Authentication Flow: From DAO to Security Context (With JWT Token Return)

---

## 1. User Submits Login Credentials

- **Action**: The user submits **email** and **password** via a login form or API request.

---

## 2. AuthenticationManager

- **Role**: Receives the authentication request and delegates the authentication process.
- **Action**:
    - It creates an **`Authentication`** object (e.g., **`UsernamePasswordAuthenticationToken`**) using the provided credentials (email and password).
    - Calls the **`AuthenticationProvider`** to validate the credentials.
- **Important Function**:
    - `authenticationManager.authenticate(authenticationToken)`

---

## 3. DaoAuthenticationProvider (AuthenticationProvider)

- **Role**: Validates the username and password against the database using a **`UserDetailsService`**.
- **Action**:
    - Fetches **`UserDetails`** from the database via **`UserDetailsService`** using the username (email).
    - Compares the provided password with the stored password (usually hashed) using a **`PasswordEncoder`** (e.g., **`BCryptPasswordEncoder`**).
    - If the credentials match, it returns an **`Authentication`** object.
    - If not, it throws an exception.
- **Important Functions**:
    - `daoAuthenticationProvider.setUserDetailsService(myUserDetailsService)`
    - `daoAuthenticationProvider.setPasswordEncoder(bCryptPasswordEncoder)`

---

## 4. UserDetailsService

- **Role**: Loads the **`UserDetails`** object (user information) from the database.
- **Action**:
    - **`UserDetailsService`** is called by **`DaoAuthenticationProvider`** to retrieve the user’s details (like password, roles, etc.) using the **username** (email).
    - It returns a **`UserDetails`** object that Spring Security uses for authentication.
- **Important Function**:
    - `myUserDetailsService.loadUserByUsername(username)`

---

## 5. PasswordEncoder

- **Role**: Encodes and decodes passwords securely.
- **Action**:
    - It is used by **`DaoAuthenticationProvider`** to compare the submitted password with the stored password (typically hashed).
    - The password is matched by hashing the input and comparing it with the hashed password from the database.
- **Important Function**:
    - `new BCryptPasswordEncoder()`
    - `passwordEncoder.matches(rawPassword, storedHashedPassword)`

---

## 6. Generate JWT Token

- **Role**: Once authentication is successful, generate a **JWT Token** for the user.
- **Action**:
    - After validating the user’s credentials, a **JWT Token** is generated by the **`JwtService`**.
    - The JWT contains encoded information like the user's username, roles, and an expiration time.
    - The token is returned to the user for use in subsequent requests (in place of sending username/password).
- **Important Function**:
    - `jwtService.generateToken(userDetails)`

---

## 7. SecurityContextHolder

- **Role**: Stores the authenticated user's information for the current session/request.
- **Action**:
    - After successful authentication, the **`Authentication`** object is set in the **`SecurityContext`**.
    - This allows Spring Security to track the user's authentication status across the session/request.
- **Important Function**:
    - `SecurityContextHolder.getContext().setAuthentication(authToken)`

---

## 8. JwtFilter (Optional, for JWT authentication)

- **Role**: Intercepts incoming HTTP requests, extracts the JWT token, and validates it.
- **Action**:
    - It checks the **`Authorization`** header for a **Bearer token**.
    - Validates the token and extracts the username.
    - If the token is valid, it loads the user details and sets the **`Authentication`** object in the **`SecurityContext`**.
- **Important Function**:
    - `SecurityContextHolder.getContext().setAuthentication(authToken)`
    - `jwtService.validateToken(token, userDetails)`

---

## Final Flow Recap

1. **User submits credentials** (email and password).
2. **`AuthenticationManager`** receives the request and delegates to **`DaoAuthenticationProvider`**.
3. **`DaoAuthenticationProvider`** uses **`UserDetailsService`** to fetch user details from the database.
4. The **password** is compared using **`PasswordEncoder`** (e.g., `BCryptPasswordEncoder`).
5. **JWT Token Generation**: After successful authentication, a **JWT token** is generated using **`JwtService`** and returned to the user.
6. **JwtFilter (Optional)**: The **`JwtFilter`** extracts the token from incoming requests, validates it, and sets the authentication in **`SecurityContextHolder`**.

---

### Key Components:

- **AuthenticationManager**: Orchestrates the authentication process and delegates to **`AuthenticationProvider`**.
- **DaoAuthenticationProvider**: Validates username/password using **`UserDetailsService`** and **`PasswordEncoder`**.
- **UserDetailsService**: Retrieves the user details from the database based on the username.
- **PasswordEncoder**: Verifies the password by comparing the stored hashed password with the input password.
- **SecurityContextHolder**: Stores the authenticated user's information for the current session/request.
- **JwtService**: Generates and validates **JWT tokens** for stateless authentication.
- **JwtFilter (Optional)**: Validates JWT tokens and sets the authentication in **`SecurityContext`**.

